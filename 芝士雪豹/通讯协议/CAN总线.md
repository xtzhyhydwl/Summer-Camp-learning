参考视频：【趋近于完美的通讯 CAN总线！4分钟看懂！】 https://www.bilibili.com/video/BV14k4y187e6/?share_source=copy_web&vd_source=1ca96e0b8c00193760c615cfbd038092

# 简介

- CAN：Controller Area Network 控制器域通信网络

- 常用于汽车内各种控制器模块的连接（铜线使用少，传输距离长）

# CAN的差分信号

- 单片机经过CAN总线需要CAN收发器，由此将普通高地电平转换为CAN的差分信号
![[Pasted image 20230728100700.png]]

- CAN总线有两根信号线HIGH、LOW，两根线电压差决定逻辑信号，故称差分信号
![[Pasted image 20230728100930.png]]

# CAN总线的抗干扰

- 双绞线缠绕的两根信号线，即使在某一点受到干扰，电压也一起变化，电压差不变
![[Pasted image 20230728101140.png]]

# CAN总线标准数据帧解读

![[Pasted image 20230728101616.png]]

1. 起始位一定是0

2. 识别码是每个设备独有的身份码

3. RTR：用于确认是数据帧还是远程请求帧，0是数据帧

4. 控制码中的IDE位：用于区分是拓展格式还是标准格式
	![[Pasted image 20230728102018.png]]
	
	即拓展模式可以挂载更多设备

5. 控制码中的DLC：Data Link Control 4位数据长度控制代码，编码从0001到1000，即1~8，表明数据长度
	![[Pasted image 20230728102313.png]]

6. 数据码，没什么好说的

7. 15位CRC校验码：通过接收到的数据计算得CRC校验码，如果与收到的不一致，则表示数据有问题，会重新发送一次

8. CRC界定符：将CRC校验码与后面的内容隔开，必定为1

9. 两位ACK码（应答）：第一位是确认位，发送逻辑1，接收逻辑0；第二位是界定位，必定为1，与后面的位隔开

10. 终止位：必为1111111，表示数据帧结束

# 仲裁：解决收发冲突

- 简单说就是两个设备**同时**收发，识别码小的优先收发，具体解读如下

# 热心网友解读线上电平与仲裁

```
这里说一下线与仲裁：  

假设有一根导线，这根导线通过一个阻止较大的电阻（比如4kΩ乃至10kΩ）连接在5V电源上，同时一个三级管的集电极也连在这根导线上，三极管的发射极接地，是0V。三极管的基极由其他电路控制。这个连接该导线和5V电源的电阻就叫上拉电阻。当三极管截止的时候，它的电阻可以视为无穷大，因此5V的电压几乎都施加在了三极管上，上拉电阻虽然很大，比如有10kΩ，但相比截止的三极管来说还是小了，因此没有太多压降，导线上的电压可以粗略地认为还是5V左右，是高电平。而如果三极管导通，它的电阻就非常小了，而且是饱和导通，CE电压一般都在0.3V左右，绝大部分的电压施加在了上拉电阻上，导线此时的电压也就是0.3V左右，可以粗略视为0V，是低电平。  

上拉电阻因为阻值很大，因此上拉能力很弱，而下拉的三极管导通时阻值非常小，因此导通时下拉能力很强。我们能看到，当输出高电平的时候，需要下拉三极管截止，也就是断开，上拉电阻才能输出高电平；但当输出低电平的时候，在下拉三极管导通的时候，并不需要断开上拉电阻，就能输出低电平。  

上面说的这个例子也可以颠倒过来，也就是导线通过大阻值电阻接地，而通过三极管接5V电源。那么这时就变成了当三极管截止时通过下拉电阻输出低电平，当三极管导通时通过上拉三极管输出高电平（但与此同时下拉电阻也并没有断开，依旧有电流流过）。  

我们把三极管截止时通过拉电阻所输出的电平叫「隐性电平」，它是输出线上的默认电平；把三极管导通时输出的那个更强势的电平叫「显性电平」，它不需要让输出隐性电平的拉电阻断开，就能直接“覆盖”掉隐性电平。

现在假设有很多设备的输出端都是这样「上拉电阻+下拉三极管」的结构，它们共用同一根导线。当所有设备的下拉三极管都截止，也就是默认状态，导线通过各设备内部的上拉电阻拉成高电平，高电平也是隐性电平。此时，只要有一个设备将输出设置为低电平，那么它的下拉三极管就会导通，输出强势的显性电平，也就是低电平，覆盖掉其他设备靠上拉电阻拉成的高电平。整条导线都会被这个强势的下拉三极管拉成低电平。因此，只要有一个设备设置成输出低电平，不论其他设备设置输出高电平还是低电平，导线都会是低电平。只有所有的设备都设置成高电平，导线才会回到高电平的状态。这就叫「线与」。

```
```
现在假设每个设备都有一个优先级码，数值越小则优先级越高。数值越小，则从高位向低位看过去，会比数值更大的更早出现0（比如7、5和3，7的二进制是111，5是101，3是011，从高位往低位，7没有0，而5的第二位就出现了0，3则是第一位就出现了0。而如果是4，也就是100，它的前两位和5相同，但最后一位出现了0，而5是1），或者说从高位往低位逐位看，两个二进制数第一次出现不同的时候，那一位是0的那个数更小，是1的那个数更大。而我们规定了数越小代表优先级越高。

此时，这些有着不同优先级的设备都使用我们上面提到的「上拉电阻+下拉三极管」的模式挂接在同一条总线上，它们高电平代表1，低电平代表0。它们在发送数据的时候会先发送自己的优先级码，从高位到地位依次发送。每发送一位的同时它们同时也检测一下那根总线上的电平，看看和自己设置的输出电平是否相同。此时如果有两个设备同时开始发送，那么当两个设备的识别码从高位到低位发送的时候，在某一位出现了不同，那么这一位发送0的那个设备的优先级码更小，优先级更高，发送1的那个设备的优先级码更大，优先级更低。因为我们前面所说的那些特性，作为显性电平的低电平会覆盖掉作为隐性电平的高电平，因此整条总线此时是低电平，也就是0。此时两个设备都检测总线上的电平是否是自己设置要输出的那个，优先级高、优先级码小的那个设备本身就要输出0，检测到总线也是0，因此继续发送；而优先级低、优先级码大的那个设备设置的输出是1，但因为1被0覆盖，它检测到总线上是0，和自己设置的1不符，因此知道同时有一个优先级更高的设备也要发送数据了，它就会停止发送数据，转为接收模式，等着看看这个数据帧是不是发给自己的。等到那个高优先级的设备发完数据，发送了明确的帧结束标志提示发送结束后，这个低优先级的设备再尝试占用总线发送自己要发送的数据。这就是靠优先级码完成的仲裁。

简单举个例子，现在有一个优先级码是4（100）的A设备和一个优先级码是5（101）的B设备要同时发送数据，A设备的优先级码更小，因此它的优先级更高。它们各自都从最高位开始发送，第一个周期两者都发送1，总线是1，和自己设置的输出相同；第二个周期两者都发送0，总线是0，和自己设置的输出也相同。第三个周期，A发送0，B发送1，因为0是显性电平，1是隐性电平，0覆盖掉了1，总线是0，这时A检测到总线的0和自己设置的输出0相同，说明自己成功获得了总线的占用权，继续发送数据；而B检测到总线的0和自己设置的输出1不同，因此得知有更高优先级的设备已经占用了总线，于是转为接受模式，开始逐位读取A发送到总线上的数据，判断这一帧数据的发送目标是自己还是总线上其他的设备。
```
```
现在说回CAN总线，它是差分工作的，但核心思想与上面那个0V-5V的体系是一样的。CAN收发芯片内部通过一些电路产生一个2.5V的参考电压和1.5V、3.5V的两个显性电平电压。CAN-High线通过下拉电阻连接2.5V，通过上拉三极管连接3.5V；CAN-Low线通过上拉电阻连接2.5V，通过下拉三极管连接1.5V；这两个三极管同时导通、同时截止。平时两个三极管都截止，CAN-High和CAN-Low都被电阻拉到2.5V左右，压差是0V，表示逻辑1，这是隐性电平；只要有一个设备要输出逻辑0，它的两个三极管就会同时导通，把CAN-High拉高到3.5V，把CAN-Low拉低到1.5V，压差是2V，表示逻辑0，这是显性电平，能覆盖表示逻辑1的隐性电平。CAN-High和CAN-Low连接在一个电压比较器上，检测两线的压差，看看和自己要输出的那个值是否相同。然后就能代入上一段所说的那个比较的方法，检测优先级顺序，判断哪个设备有资格优先占用总线了。
```